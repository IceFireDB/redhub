name: Benchmark Tests

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-tools netcat

    - name: Run benchmark
      run: |
        # Start server in background
        cd example/memory_kv
        go run server.go &
        SERVER_PID=$!
        
        # Wait for server to be ready
        for i in {1..10}; do
          if nc -z 127.0.0.1 6380; then
            break
          fi
          sleep 1
        done
        
        # Verify server is ready
        if ! nc -z 127.0.0.1 6380; then
          echo "Server failed to start"
          exit 1
        fi
        
        # Run benchmark tests
        echo "Running benchmark tests..."
        redis-benchmark -h 127.0.0.1 -p 6380 -n 50000 -t set,get -c 512 -P 1024 -q
        
        # Stop server
        kill $SERVER_PID
        
        # Output results
        echo "Benchmark completed"
